---
title: "Modul 01: An der Weggabelung: Einen Weg gehen - und einen nicht"
output: 
  learnr::tutorial:
    progressive: true
    css: "css/style.css"
runtime: shiny_prerendered
---


```{r setup, include=FALSE}
library(learnr)
library(mosaic)
library(tidyr)
library(knitr)
library(ggthemes)

theme.fom <- theme_classic(22*1.04)
theme.fom <- theme.fom
theme_set(
  theme.fom  
)


# Daten simulieren
set.seed(1896)
n <- 10

Schulung <- tibble(finteresse = rnorm(n)) %>%
  rowwise() %>%
  mutate(pteilnahme = pnorm((finteresse+rnorm(1)))) %>%
  mutate(teilnahme = sample(c("Ja", "Nein"), 
                            size = 1, prob = c(pteilnahme, 1-pteilnahme))) %>%
  mutate(gehalt0 = 2000 * (1 + pnorm((finteresse + rnorm(1)))/10)) %>%
  mutate(gehalt1 = gehalt0 * (1 + rbeta(1,1,10))) %>%
  mutate(effekt = gehalt1 - gehalt0) %>%
  mutate(gehalt = case_when(teilnahme == "Ja" ~ gehalt1,
                            teilnahme == "Nein" ~ gehalt0)) %>%
  mutate(across(where(is.numeric), ~ round(.x,2))) %>%
  ungroup() %>%
  mutate(i=row_number()) %>%
  select(i, teilnahme, gehalt0, gehalt1, effekt, gehalt)
```

## Lernziele

In diesem Modul lernen Sie:

- Was ein *Potential Outcome* ist.

- Was ein *Counterfactual* ist.

- Wie *Kausale Effekte* definiert werden können.

- Warum die Bestimmung von kausalen Effekten so herausfordernd ist.

## Individueller kausaler Effekt

Stellen Sie sich folgende Situation vor: Am Ende der Ausbildungszeit wird eine freiwillige Schulung zum Thema Gehaltsverhandlungen angeboten.

Würden Sie teilnehmen?

Und wie würden Sie für sich den **Individuellen Kausalen Effekt** der Teilnahme an der Schulung auf Ihr Gehalt definieren. D.h., die Frage ist, wie viel höher ist Ihr Gehalt aufgrund der Schulung?

*Denken Sie bitte kurz darüber nach und klicken Sie erst dann auf `Next Topic`*

##

Manche antworten hier vielleicht *Gehalt nach der Schulung minus Gehalt vor der Schulung*. Aber das ist es nicht wirklich. Vielleicht hätte sich ja auch ohne die Teilnahme an der Schulung Ihr Gehalt erhöht. So wie manche Krankheiten mit oder ohne Behandlung verschwinden.

Eine andere Möglichkeit ist es, diesen Effekt als 

$$\text{Gehalt mit Schulung} - \text{Gehalt ohne Schulung} $$

zu definieren.

Wenn Sie vor der Entscheidung stehen: *Nehme ich an der Schulung teil?* gibt es für Ihr Gehalt zwei **potenzielle Ergebnisse** (engl.: Potential Outcomes):

- <purple> Gehalt </purple> ohne <olive> Schulung <olive>: $\color{purple}{Y}^{\color{olive}{X=0}}$

- <purple> Gehalt </purple> mit <olive> Schulung <olive>: $\color{purple}{Y}^{\color{olive}{X=1}}$

![](images/Weggabel.png){width="65%"}

##

Mathematisch dargestellt ergibt sich dann der **individuelle kausale Effekt** $\color{blue}{\Delta}_i$ (gr.: Delta) der Schulung als:

$$\color{blue}{\Delta}_i = \color{purple}{Y}^{\color{olive}{X=1}}_i - \color{purple}{Y}^{\color{olive}{X=0}}_i$$

Wobei

- $i$ für die einzelne Beobachtung, hier die einzelne Person steht

- $\color{purple}{Y}_i$ für das <purple> Gehalt </purple> von $i$

- $\color{olive}{X}$ für die Teilnahme an der <olive> Schulung </olive>; dabei ist $\color{olive}{X_i=1}$ wenn $i$ teilnimmt und  $\color{olive}{X_i=0}$ wenn $i$ nicht teilnimmt.


## Ein fiktives Beispiel

Schauen wir uns einmal eine fiktive Gehaltstabelle von Potential Outcomes an:

- `i`: Laufende Nummer der Beobachtung.

- `gehalt1`: $\color{purple}{Y}^{\color{olive}{X=1}}$, Gehalt mit Schulung

- `gehalt0`: $\color{purple}{Y}^{\color{olive}{X=0}}$, Gehalt ohne Schulung

```{r gehaltstabelle, echo=FALSE}
Schulung %>%
  select(i, gehalt1, gehalt0) %>%
  kable()
```


Der individuelle kausale Effekt $\color{blue}{\Delta}_i$ lässt sich dann in `R` innerhalb der Datentabelle `Schulung` berechnen als `gehalt1 - gehalt0`:

```{r}
Schulung <- Schulung %>%
  mutate(effekt = gehalt1 - gehalt0)
```

Und damit:

```{r gehaltstabelleeffekt, echo=FALSE}
Schulung %>%
  select(i, gehalt1, gehalt0, effekt) %>%
  kable()
```

```{r visualisierung, echo=FALSE}
Schulung_Long <- Schulung %>%
  select(i, gehalt0, gehalt1) %>%
  pivot_longer(c(gehalt0, gehalt1), values_to = "Gehalt", names_to = "Schulung") %>%
  mutate(Schulung = ifelse(Schulung == "gehalt0", "0: Nein", "1: Ja"))

gf_point(Gehalt ~ Schulung, data = Schulung_Long,
         position = "jitter", width = 0.01, height = 0,
         color = ~ Schulung,
         show.legend = FALSE) %>%
  gf_line(Gehalt ~ Schulung, group = ~ i,
          color = "blue", alpha = 0.25) +
  scale_color_colorblind()
```


```{r ike, echo=FALSE}
question("Lässt sich der individuelle kausale Effekt in der Praxis beobachten?",
         answer("Ja", message = "Je Beobachtung $i$ liegt nur ein Wert vor: Der mit Schulung oder der ohne Schulung, nicht beide gleichzeitig. $\\Delta_i$ kann nicht beobachtet werden."),
         answer("Nein", correct = TRUE, message = "Je Beobachtung $i$ liegt nur ein Wert vor: Der mit Schulung oder der ohne Schulung, nicht beide gleichzeitig. $\\Delta_i$ kann nicht beobachtet werden."),
		correct = "Prima, Richtig!",
		incorrect = "Leider falsch."
         )
```

## Das Problem

Das fundamentale Problem der kausalen Inferenz ist, dass wir den individuelle kausale Effekt $\color{blue}{\Delta}_i = \color{purple}{Y}^{\color{olive}{X=1}}_i - \color{purple}{Y}^{\color{olive}{X=0}}_i$ **nicht** beobachten können. Es liegt je Beobachtung $i$ immer nur eines der beiden Potential Outcomes vor: Entweder $\color{purple}{Y}^{\color{olive}{X=1}}$ (<purple> Gehalt </purple> mit <olive> Schulung </olive>) **oder** $\color{purple}{Y}^{\color{olive}{X=0}}$ (<purple> Gehalt </purple> ohne <olive> Schulung </olive>).

- Wenn Person $i$ an der Schulung teilnimmt liegt uns das Gehalt mit Schulung vor, $\color{purple}{Y}^{\color{olive}{X=1}}_i$, und nicht $\color{purple}{Y}^{\color{olive}{X=0}}_i$

- Wenn $i$ nicht an der Schulung teilnimmt liegt uns das Gehalt ohne Schulung vor, $\color{purple}{Y}^{\color{olive}{X=0}}_i$, und nicht $\color{purple}{Y}^{\color{olive}{X=1}}_i$

Der Wert der nicht vorliegt wird **Counterfactual** genannt. Für jemanden der nicht an der Schulung teilgenommen hat ist das Counterfactual die Antwort auf die Frage: *Wie hoch wäre mein Gehalt, wenn ich an der Schulung teilgenommen hätte?*. Für jemanden der teilgenommen hat ist das Counterfactual das Gehalt ohne Teilnahme.

```{r cf, echo=FALSE}
question("Kann das Counterfactual beobachtet werden?",
         answer("Ja", message = "Je Beobachtung $i$ liegt nur ein Wert vor: Der mit Schulung oder der ohne Schulung, nicht beide gleichzeitig. Das Counterfactual ist das nicht beobachtete der Potential Outcomes."),
         answer("Nein", correct = TRUE, message = "Das Counterfactual ist das nicht beobachtete der Potential Outcomes."),
		correct = "Richtig!",
		incorrect = "Leider falsch."
         )
```

```{r cfi, echo=FALSE}
question("Person $i$ nimmt an der Schulung teil. Was ist dann das Counterfactual?",
         answer("$\\color{purple}{Y}^{\\color{olive}{X=0}}_i$", correct = TRUE, message = "Teilnahme an der Schulung bedeutet $X=1$."),
         answer("$\\color{purple}{Y}^{\\color{olive}{X=1}}_i$", message = "Teilnahme an der Schulung bedeutet $X=1$."),
		correct = "Klasse!",
		incorrect = "Leider falsch."
         )
```


## Durchschnittlicher kausaler Effekt

Würden wir den individuelle kausale Effekt $\color{blue}{\Delta}_i$ kennen (Variable `effekt` in unserem `R` Beispiel), könnten wir u.a. den durchschnittlichen kausalen Effekt berechnen, indem wir alle $i$ individuellen kausalen Effekte addieren und diese Summe ($\sum$) durch die Anzahl der Beobachtungen ($n$) dividieren: 

$$\bar{\color{blue}{\Delta}}=\frac{\sum_{i=1}^n \color{blue}{\Delta}_i}{n}=\frac{\sum_{i=1}^n\color{purple}{Y}^{\color{olive}{X=1}}_i - \sum_{i=1}^n\color{purple}{Y}^{\color{olive}{X=0}}_i}{n}=\overline{\color{purple}{Y}}^{\color{olive}{X=1}}-\overline{\color{purple}{Y}}^{\color{olive}{X=0}}.$$

Die `R` Funktion die diesen arithmetischen Mittelwert berechnet lautet `mean()`.

Berechnen Sie den durchschnittlichen kausalen Effekt, wenn beide Potential Outcomes vorliegen würden, indem Sie auf `Run Code` klicken. 

```{r ate, exercise=TRUE}
mean(~ effekt, data = Schulung)
```

##

Das fundamentalen Problems der kausalen Inferenz ist, dass nur eines der Potential Outcomes vorliegt, und das nicht vorliegende ein Counterfactual ist. Daher kennen wir in der Praxis weder den individuellen noch den durchschnittlichen kausalen Effekt. Letzterer läge hier bei


$$\bar{\color{blue}{\Delta}}=\frac{\sum_{i=1}^n \color{blue}{\Delta}_i}{n}=`r mean(~ effekt, data = Schulung)`.$$

## Fehlende Werte

Wenn wir wissen wer teilgenommen hat, wissen wir auch welche der beiden Potential Outcomes wir kennen, und welche als Counterfactual fehlen. Fehlende Werte werden in `R` als `NA` (engl.: not available, nicht verfügbar) dargestellt.

```{r teilnahme, echo=FALSE}
Schulung %>%
  select(i, teilnahme, gehalt0, gehalt1) %>%
  mutate(gehalt0 = ifelse(teilnahme=="Ja", NA, gehalt0)) %>%
  mutate(gehalt1 = ifelse(teilnahme=="Nein", NA, gehalt1)) %>%
  kable()
```

Was wir also sehen ist, ist das `gehalt` und ob am Seminar teilgenommen wurde (`teilnahme`).

```{r gehalt, echo=FALSE}
Schulung %>%
  select(i, teilnahme, gehalt) %>%
  kable()
```

```{r bias, echo=FALSE}
question("Die Teilnahme an der Schulung war freiwillig. Sind Sie sicher, dass diejenigen die teilgenommen haben und diejenigen die nicht teilgenommen haben die gleiche Gehaltsentwicklung gehabt hätten, unabhängig von der Schulung?",
         answer("Eher Ja", message = "Es gibt vermutlich Unterschiede in der individuellen Einschätzung der Wichtigkeit der Höhe des Gehalts. Dies kann sowohl die Teilnahmebreitschaft an der Schulung beeinflussen als auch - unabhängig von der Schulung - das Vorgehen in Gehaltsverhandlungen."),
         answer("Eher Nein", correct = TRUE, message = "Es gibt vermutlich Unterschiede in der individuellen Einschätzung der Wichtigkeit der Höhe des Gehalts. Dies kann sowohl die Teilnahmebreitschaft an der Schulung beeinflussen als auch - unabhängig von der Schulung - das Vorgehen in Gehaltsverhandlungen."),
		correct = "Klasse!",
		incorrect = "Leider falsch."
         )
```

## Schätzung des kausalen Effektes

Anhand der beobachteten Daten kann das durchschnittliche Gehalt sowohl für diejenigen, die teilgenommen haben, also auch für die, die nicht teilgenommen haben, berechnet werden:

```{r gehaltteilnahme}
mean(gehalt ~ teilnahme, data = Schulung)
```

- $\bar{\color{purple}{y}}^{\color{olive}{x=1}} = `r round(mean(gehalt ~ teilnahme, data = Schulung)[1],2)`$

- $\bar{\color{purple}{y}}^{\color{olive}{x=0}} = `r round(mean(gehalt ~ teilnahme, data = Schulung)[2],2)`$

Ein Schätzer für den durchschnittlichen kausalen Effekt auf Basis der beobachteten Werte wäre damit:

$$\bar{\color{purple}{y}}^{\color{olive}{x=1}} - \bar{\color{purple}{y}}^{\color{olive}{x=0}} = `r round(mean(gehalt ~ teilnahme, data = Schulung)[1],2)` - `r round(mean(gehalt ~ teilnahme, data = Schulung)[2],2)` = `r round(-diffmean(gehalt ~ teilnahme, data = Schulung),2)`$$

Dieser weist aber eine systematische Verzerrung, einen **Bias** zum zu schätzenden Wert $\bar{\color{blue}{\Delta}} =`r round(mean(~ effekt, data = Schulung),2)`$ auf.

Der naive Vergleich der Mittelwerte überschätzt hier den wahren durchschnittlichen Effekt. Dies liegt daran, dass in diesem fiktiven Beispiel Personen mit einem höherem Gehaltsinteresse eher an der Schulung teilgenommen haben als die mit einem niedrigeren Interesse. Erstere hätten aber, aufgrund Ihres Gehaltsinteresses so oder so, also unabhängig von der Schulung, ein höheres Gehalt erwartet.

Kontrollieren Sie diese Aussage, indem Sie den Code so abändern, dass Sie den Mittelwert der Potential Outcomes berechnen:

*Tipp*: Einen Lösungshinweis erhalten Sie über `Hints`. Anschließend `Next Hint` und Sie sehen die Lösung.

```{r po, exercise = TRUE}
mean(gehalt ~ teilnahme, data = Schulung)
```

```{r po-solution}
mean(gehalt0 ~ teilnahme, data = Schulung)
mean(gehalt1 ~ teilnahme, data = Schulung)
```

```{r po-hint}
"gehalt0 bzw. gehalt1 sind die Variablennamen. Ändern Sie gehalt entsprechend."
```


##

Dies ist leider ein universelles Problem: Daten können viel erzählen und verbergen. Wir können Zusammenhänge und Unterschiede sehen, wo keine sind, wir können welche übersehen die da sind. Daten können in die Irre führen. Um die richtigen Schlussfolgerungen aus ihnen zu ziehen müssen wir die Entstehungsgeschichte der Daten berücksichtigen. 

## Hinweis

<red> **Dieser Kurs ist aktuell noch in der Entwicklung!** </red>

Bitte melden Sie Fehler, Unklarheiten und Verbesserungsvorschläge [hier](https://github.com/luebby/WWWEKI/issues).

Das Vorhaben *Was, wie, warum? Einstiegskurs Kausale Inferenz (WWWEKI)* wird mit Mitteln des Bundesministeriums für Bildung und Forschung unter dem Förderkennzeichen 16DHBQP040 gefördert.


![Logo BMBF](images/csm_Logo-BMBF.jpg)



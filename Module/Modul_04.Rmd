---
title: "Modul 04: Es steht was zwischen uns"
output: 
  learnr::tutorial:
    language: 
      de: js/tutorial_de.json
    progressive: true
    css: "css/style.css"
runtime: shiny_prerendered
---


```{r setup, include=FALSE}
library(learnr)
library(knitr)
library(ggplot2)
library(dplyr)
library(tidyr)
library(emojifont)

theme.fom <- theme_classic(22*1.04)
theme.fom <- theme.fom
theme_set(
  theme.fom  
)

# deutsche Version von random_praise
source("random-praise_de/translation_random-praise_de.R")


library(ggdag)
# DAG
co <- data.frame(x=c(0,1,2), y=c(0,0,0), name=c("X", "Z", "Y"))
DAG_Chain <- dagify(Z ~ X,
                    Y ~ Z,
                   coords = co) %>% 
  ggdag() + 
  geom_dag_point(colour = c("#0F710B", "#DA70D6", "#0000FF")) + 
  geom_dag_text(size = 8) +
  theme_dag_blank() +
  geom_dag_edges(arrow_directed = grid::arrow(length = grid::unit(15, "pt"), type = "closed")) +
  geom_text(label = "X - Lernen\nZ - Wissen\nY - Verstehen", 
            hjust = 1, vjust = 2,
            x = 2, y = 0, size = 7, color = "darkgrey") 


library(mosaic)

U_X <- function(n = 1) runif(n, min = 1, max = 10)
f_Z <- function(x) 5*x + rnorm(length(x))
f_Y <- function(z) 3*z + rnorm(length(z))

# Daten und Funktion
set.seed(1992)
n <- 100
SimData <- tibble(x = U_X(n)) %>%
  mutate(z = f_Z(x)) %>%
  mutate(y = f_Y(z))

# Ergebnisse
ModellA <- lm(y ~ x, data = SimData)
```

## Lernziele

In diesem Modul lernen Sie:

- was eine kausale Kette ist;

- was ein Mediator ist;

- dass es manchmal besser ist, etwas nicht zu berücksichtigen.

## Eins führt zum anderen

Auch komplexe kausale Diagramme^[Siehe Modul 2.] bestehen aus relativ einfachen Grundelementen. Eines davon ist die sog. **Kette** (engl.: chain). 

Zur Erinnerung: Der kausale Fluss folgt den Pfeilen. $$A \rightarrow B$$ sagt aus, dass $B$ auf $A$ *hört*, aber nicht umgekehrt. Wenn ich den Rasen gieße ($A$), wird dieser nass ($B$), aber der Rasen kann auch nass sein, ohne dass ich ihn gegossen habe. Bei einer Kette kommt einfach eine dritte Variable dazu: $$A \rightarrow B \rightarrow C.$$ Das Drehen am Thermostat ($A$) führt zum Erwärmen der Heizung ($B$) und diese wiederum zu einem warmen Wohnraum ($C$).

## Lernen und Verstehen

Das folgende Beispiel ist fiktiv &ndash; und eine sehr starke Vereinfachung. Außerdem werden die wichtigen Fragen, wie die Variablen jeweils gemessen werden, nicht behandelt.^[Siehe hierzu z. B. "Welche Information steckt in Daten?" aus dem KI-Campus Kurs [Stadt | Land | DatenFluss](https://ki-campus.org/datenfluss).]

Angenommen <green> Lernen </green> ($\color{green}{X}$) führt zu <violet> Wissen </violet> ($\color{violet}{Z}$), d. h., durch Lernen erwerben Sie Wissen. Außerdem führt <violet> Wissen </violet> ($\color{violet}{Z}$) zu <blue> Verstehen </blue> ($\color{blue}{Y}$), d. h., über Ihr Wissen kommen Sie zum Verstehen.

Wenn dieses stark vereinfachte Modell stimmt, dann lässt sich diese Annahme in einem kausalen Diagramm darstellen:

```{r DAG_Chain, echo=FALSE, fig.align='center', out.width='85%'}
plot(DAG_Chain)
```

##

Das strukturelle kausale Modell besteht aus folgenden Zuweisungen:

\begin{eqnarray*}
\color{green}{X} &=& U_{\color{green}{X}}\\
\color{violet}{Z} &=& f_{\color{violet}{Z}}(\color{green}{X}, U_{\color{violet}{Z}})\\
\color{blue}{Y} &=& f_{\color{blue}{Y}}(\color{violet}{Z},U_{\color{blue}{Y}}).
\end{eqnarray*}

Der Wert von <green> Lernen </green> ($\color{green}{X}$) kommt außerhalb des Modells zu Stande ($U_{\color{green}{X}}$). Der Wert von <violet> Wissen </violet> ($\color{violet}{Z}$) hängt ab vom Wert von <green> Lernen </green> ($\color{green}{X}$) &ndash; und weiteren Faktoren ($U_{\color{violet}{Z}}$). Letzlich hängt <blue> Verstehen </blue> ($\color{blue}{Y}$) von <violet> Wissen </violet> ($\color{violet}{Z}$) ab &ndash; und $U_{\color{blue}{Y}}$. Dabei sind die zufälligen Einflüsse $U_{\color{green}{X}}, U_{\color{violet}{Z}}, U_{\color{blue}{Y}}$ unabhängig voneinander.

```{r kind, echo=FALSE}
question("In der Sprache der Diagramme: Ist Verstehen ($Y$) ein Kind von Lernen ($X$)?",
         answer("Ja", message = "Eltern von Verstehen ist Wissen ($Z$). Wissen ist ein Kind von Lernen. Verstehen *hört* unmittelbar nur auf Wissen, d. h., der Wert von Verstehen hängt direkt nur von Wissen ab &ndash; und nur über dieses von Lernen."),
         answer("Nein", correct = TRUE, message = "Eltern von Verstehen ist Wissen ($Z$). Wissen ist ein Kind von Lernen. Verstehen *hört* unmittelbar nur auf Wissen, d. h., der Wert von Verstehen hängt direkt nur von Wissen ab &ndash; und nur über dieses von Lernen."),
		correct = "Prima, Richtig!",
		incorrect = "Leider falsch. Vielleicht schauen Sie noch einmal im Modul 2 nach."
         )
```

## Mediator

In Fällen wie diesen: $$\color{green}{X} \rightarrow \color{violet}{Z} \rightarrow \color{blue}{Y}$$ wird die Variable in der Mitte &ndash; hier $\color{violet}{Z}$ &ndash; **Mediator** genannt.

```{r mediator, echo=FALSE}
question("Angenommen eine Beförderung hängt diskriminierenderweise ab vom Geschlecht der Kandidat:in und das Gehalt von der Beförderung. Welche Variable ist hier ein Mediator?",
         answer("Geschlecht", message = "Das beschriebene Kausalmodell lautet $\\text{Geschlecht} \\rightarrow \\text{Beförderung} \\rightarrow \\text{Gehalt}$."),
         answer("Beförderung", correct = TRUE, message = "Das beschriebene Kausalmodell lautet $\\text{Geschlecht} \\rightarrow \\text{Beförderung} \\rightarrow \\text{Gehalt}$."),
         answer("Gehalt", message = "Das beschriebene Kausalmodell lautet $\\text{Geschlecht} \\rightarrow \\text{Beförderung} \\rightarrow \\text{Gehalt}$."),
		correct = "Super!",
		incorrect = "Leider falsch."
         )
```

Um den (totalen^[Wir können sogenannte *totale*, *direkte* und *indirekte* Effekte unterscheiden.]) kausalen Effekt der Ursache ($\color{green}{X}$) auf die Wirkung ($\color{blue}{Y}$) zu untersuchen, müssen wir den Wert des Mediators ($\color{violet}{Z}$) nicht kennen. Wenn z. B. <green> Frauen </green> selterner <violet> befördert </violet> werden, habe ich ein falsches Bild von der Diskrimnierung bei dem <blue> Gehalt </blue> aufgrund des <green> Geschlechts </green>. Die (mögliche) Benachteiligung beginnt schon bei der <violet> Beförderung </violet>.


## Simulierte Daten

In `R` sind Simulationen für das Modell 

\begin{eqnarray*}
\color{green}{X} &=& U_{\color{green}{X}}\\
\color{violet}{Z} &=& f_{\color{violet}{Z}}(\color{green}{X}, U_{\color{violet}{Z}})\\
\color{blue}{Y} &=& f_{\color{blue}{Y}}(\color{violet}{Z},U_{\color{blue}{Y}}).
\end{eqnarray*}

hinterlegt. Simulieren Sie Beobachtungen in dem Sie mehrfach auf `Run Code` klicken:

```{r sim, exercise=TRUE}
x <- U_X()
cat("Wert x (Lernen):", x, "\n")
z <- f_Z(x)
cat("Wert z (Wissen):", z, "\n")
y <- f_Y(z)
cat("Wert y (Verstehen):", y, "\n")
```

```{r beobachtung, echo=FALSE}
question("Was passiert, wenn Sie höhere Werte von Lernen (`x`) beobachten?",
         answer("Bei höheren Werten von Lernen (`x`) treten in der Regel auch höhere Werte von Verstehen (`y`) auf.", correct = TRUE, message = "Es lässt sich ein positiver Zusammenhang zwischen $X$ und $Y$ beobachten."),
         answer("Bei höheren Werten von Lernen (`x`) treten in der Regel niedrigere Werte von Verstehen (`y`) auf.", message = "Es lässt sich ein positiver Zusammenhang zwischen $X$ und $Y$ beobachten."),
         answer("Der Wert von Verstehen (`y`) scheint in keinem Zusammenhang mit dem Wert von Lernen (`x`) zu stehen.", message = "Es lässt sich ein positiver Zusammenhang zwischen $X$ und $Y$ beobachten."),
		correct = "Toll!",
		incorrect = "Leider falsch."
         )
```

## Intervention

Durch Festsetzen von $\color{green}{X}$, also $do(\color{green}{X}=x)$ anstelle von $\color{green}{X} = U_{\color{green}{X}}$ kann eine Intervention simuliert werden.

Im Code-Beispiel ist $do(\color{green}{X}=1)$. Drücken Sie zunächst ein paar Mal auf `Run Code` um zu gucken, wie die Werte von Verstehen ($\color{blue}{Y}$) im Falls von $do(\color{green}{X}=1)$ aussehen. Ändern Sie anschließend den Code so, dass Sie $do(\color{green}{X}=10)$ simulieren können. Was passiert?

```{r simdo, exercise=TRUE}
 # do(X=1)
x <- 1
cat("Wert x (Lernen):", x, "\n")
z <- f_Z(x)
cat("Wert z (Wissen):", z, "\n")
y <- f_Y(z)
cat("Wert y (Verstehen):", y, "\n")
```

```{r simdo-solution}
 # do(X=10)
x <- 10
cat("Wert x (Lernen):", x, "\n")
z <- f_Z(x)
cat("Wert z (Wissen):", z, "\n")
y <- f_Y(z)
cat("Wert y (Verstehen):", y, "\n")
```

##

Während die Werte für $\color{blue}{Y}$) bei $do(\color{green}{X}=1)$ um die $\color{blue}{15}$ schwanken, liegen sie bei $do(\color{green}{X}=10)$ um die $\color{blue}{150}$.

```{r intervention, echo=FALSE}
question("Was wird mit mit den Zusammenhang zwischen Lernen (`x`) und Verstehen (`y`) passieren, wenn Sie Wissen festhalten, also z.B. `z <- 15` zuweisen?",
         answer("Bei höheren Werten von Lernen (`x`) treten in der Regel auch höhere Werte von Verstehen (`y`) auf.", message = "Durch Fixierung von `z` wird die kausale Kette von $X$ nach $Y$ unterbrochen."),
         answer("Bei höheren Werten von Lernen (`x`) treten in der Regel niedrigere Werte von Verstehen (`y`) auf.", message = "Durch Fixierung von `z` wird die kausale Kette von $X$ nach $Y$ unterbrochen."),
         answer("Bei bekannten Wissen (`z`) scheint der Wert von Verstehen (`y`) in keinem Zusammenhang mit dem Wert von Lernen (`x`) zu sein.", correct = TRUE, message = "Durch Fixierung von `z` wird die kausale Kette von $X$ nach $Y$ unterbrochen."),
		correct = "Klasse!",
		incorrect = "Leider falsch."
         )
```

##

Probieren Sie dies ruhig aus:

```{r sim2, exercise=TRUE}
x <- U_X()
cat("Wert x (Lernen):", x, "\n")
z <- 15
cat("Wert z (Wissen):", z, "\n")
y <- f_Y(z)
cat("Wert y (Verstehen):", y, "\n")
```

## Kausales Modell

Die zugrunde liegenden Gleichungen des kausalen Modells lauten:

\begin{eqnarray*}
\color{green}{X} &=& U_{\color{green}{X}}, \quad U_{\color{green}{X}} \sim \mathcal{G}(1,\,10), \\
\color{violet}{Z} &=& 5 \cdot \color{green}{X} +  U_{\color{violet}{Z}}, \quad U_{\color{violet}{Z}} \sim \mathcal{N}(0,\,1), \\
\color{blue}{Y} &=& 3 \cdot \color{violet}{Z} + U_{\color{blue}{Y}}, \quad U_{\color{blue}{Y}} \sim \mathcal{N}(0,\,1).
\end{eqnarray*}

Dabei steht $\mathcal{G}(1,\,10)$ für eine *Gleichverteilung* auf den Bereich von $1$ bis $10$ und $\mathcal{N}(0,\,1)$ für eine *Normalverteilung* mit den Parametern $\mu=0$ und $\sigma=1$, also eine Standardnormalverteilung. Die konkreten Funktionen und Parameter sind hier willkürlich gewählt.

Für $n=100$ simulierten Beobachtungen lautet der dazugehörige `R`-Code:

```{r RSim, eval = FALSE}
## Vorbereitungen 
library(mosaic) # Paket laden
set.seed(1896) # Zufallszahlengenerator setzen (Reproduzierbarkeit)

## Funktionen
U_X <- function(n = 1) runif(n, min = 1, max = 10)
f_Z <- function(x) 5 * x + rnorm(length(x))
f_Y <- function(z) 3 * z + rnorm(length(z))

## Datentabelle
n <- 100 # Anzahl Beobachtungen
SimData <- tibble(x = U_X(n)) %>%
  mutate(z = f_Z(x)) %>%
  mutate(y = f_Y(z)
```

## Lineare Regression, Versuch 1

Ein Verfahren, um Zusammenhänge zwischen Variablen $\color{green}{X}$ und $\color{blue}{Y}$ anhand von beobachteten Daten zu schätzen, ist die **Lineare Regression**^[Siehe hierzu z. B. "Maschinelles Lernen" aus dem KI-Campus Kurs [The Elements of AI](https://ki-campus.org/courses/elementsofai).]. Dabei wird angenommen, dass der Zusammenhang zwischen $\color{blue}{Y}$ und den weiteren Variablen im Modell linear ist, d. h., es müssen *nur* die jeweiligen Steigungen geschätzt werden, die den Zusammenhang beschreiben:

```{r streu, out.width='80%', fig.align='center', echo = FALSE}
gf_point(y ~ x, data = SimData) %>% # Streudiagramm
  gf_lm() %>% # Regressionsgerade
  gf_labs(x = "x: Lernen", y = "y: Verstehen") # Achsenbeschriftung 
```

In `R` kann eine lineare Regression über die Funktion `lm()` berechnet werden.

Ohne den Mediator <violet> Wissen </violet> ergibt sich folgendes Modell:

```{r lmoz}
# Regression Rechnen
ModellA <- lm(y ~ x, data = SimData)
# Ergebnis
ModellA
```

D. h.:

$$\widehat{\color{blue}{\text{Verstehen}}} = `r round(coef(ModellA)[1],2)` + `r round(coef(ModellA)[2],2)` \times \color{green}{\text{Lernen}}$$

Gemäß dieses Modells liegt der (totale) kausale Effekt von <green>Lernen</green> auf <blue>Verstehen</blue> bei $`r round(coef(ModellA)[2],2)`$: Wird <green> Lernen</green> um eine Einheit erhöht, erhöht sich der Mittelwert von <blue> Verstehen </blue> um $`r round(coef(ModellA)[2],2)`$ Einheiten.

## Lineare Regression, Versuch 2

Wenn der Mediator <violet> Wissen</violet>, $\color{violet}{Z}$, mit in das Modell aufgenommen wird, ändert sich das Ergebnis der Linearen Regression:

```{r lmmz}
# Regression Rechnen
ModellB <- lm(y ~ x + z, data = SimData)
# Ergebnis
ModellB
```

D. h.:

$$\widehat{\color{blue}{\text{Verstehen}}} = `r round(coef(ModellB)[1],2)` + `r round(coef(ModellB)[2],2)` \times \color{green}{\text{Lernen}} + `r round(coef(ModellB)[3],2)` \times \color{violet}{\text{Wissen}}$$
Wenn <violet>Wissen</violet> Teil des Modell ist, wir also das <violet>Wissen</violet> berücksichtigen, um den kausalen Effekt von <green>Lernen</green> auf <blue>Verstehen</blue> zu bestimmen, dann sagt unser Modell jetzt: Wird <green> Lernen</green> um eine Einheit erhöht, erhöht sich der Mittelwert von <blue> Verstehen </blue> um $`r round(coef(ModellB)[2],2)`$ Einheiten &ndash; ein viel kleinerer Wert als ohne die Berücksichtigung ($`r round(coef(ModellA)[2],2)`$).

```{r adjustierung, echo=FALSE}
question("Welcher Wert beschreibt den (totalen) kausalen Effekt von Lernen (`x`) auf Verstehen (`y`) richtig? Um wie viel Einheiten wird sich der Wert von Verstehen im Mittelwert ändern, wenn eine Einheit mehr gelernt wird?",
         answer("Das Modell ohne Wissen (`ModellA`), d. h. $14.86$.", correct = TRUE, message = "Durch Fixierung von `z` wird die kausale Kette von $X$ nach $Y$ unterbrochen."),
         answer("Das Modell mit Wissen (`ModellB`), d. h. $0.86$.", message = "Durch Fixierung von `z` wird die kausale Kette von $X$ nach $Y$ unterbrochen."),
		correct = "Super!",
		incorrect = "Leider falsch."
         )
```

## Zusammenfassung

:::{.box}
Um den (totalen) kausalen Effekt von $X$ auf $Y$ in einer Kette $$X \rightarrow Z \rightarrow Y$$ zu bestimmen, sollte ein Mediator $Z$ **nicht** berücksichtigt werden. Bei festem $Z$ wird der kausale Zusammenhang zwischen $X$ und $Y$ unterbrochen.
::: 

## Hinweis

<red> **Dieser Kurs ist aktuell noch in der Entwicklung!** </red>

Bitte melden Sie Fehler, Unklarheiten und Verbesserungsvorschläge [hier](https://github.com/luebby/WWWEKI/issues).

Das Vorhaben *Was, wie, warum? Einstiegskurs Kausale Inferenz (WWWEKI)* wird mit Mitteln des Bundesministeriums für Bildung und Forschung unter dem Förderkennzeichen 16DHBQP040 gefördert.


![](images/csm_Logo-BMBF.jpg)


